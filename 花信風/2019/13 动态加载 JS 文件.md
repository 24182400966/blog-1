[pixiv: 44900302]: # 'https://i.loli.net/2019/04/21/5cbc32e68ad46.jpg'

对于 Vue、React 等框架开发的单页面应用，在某些页面开发特殊功能时经常需要依赖第三方 JS 文件，如果在全局引入 CDN 资源可能会加载冗余文件，此时最好使用动态加载方式。

动态加载 JS 脚本指仅在某些特殊页面引入依赖文件，而非全局引入，这样可以避免这些页面并未打开时造成加载无用的资源，提高页面加载速度的同时，也让整个项目更加模块化。

文档对象模型（DOM）允许使用 JavaScript 动态创建 HTML。`<script>` 元素也是如此，它与页面其他元素没有什么不同，所以可以手动创建 `<script>` 来加载 JS 文件，通过监听 `onload` 事件来判断文件是否加载完成。

```javascript
const loadJS = url => {
  return new Promise(resolve => {
    const recaptchaScript = document.createElement('script')
    recaptchaScript.setAttribute('src', url)
    recaptchaScript.defer = true
    recaptchaScript.onload = () => {
      resolve()
    }
    document.head.appendChild(recaptchaScript)
  })
}
```

> defer：此布尔属性被设置为向浏览器指示脚本在文档被解析后执行。  
> async：设置此布尔属性，以指示浏览器如果可能的话，应异步执行脚本。

对于 `defer`，可以认为是将外链的 js 放在了页面底部。js 的加载不会阻塞页面的渲染和资源的加载。不过 `defer` 会按照原本的 js 的顺序执行。

对于 `async`，这个是 html5 中新增的属性，它的作用是能够异步的加载和执行脚本，不因为加载脚本而阻塞页面的加载。一旦加载到就会立刻执行在有 `async` 的情况下，js 一旦下载好了就会执行，所以很有可能不是按照原本的顺序来执行的。如果 js 前后有依赖性，用 `async`，就很有可能出错。

当需要引入多个 JS 资源时，文件加载也分为同步加载和异步记载，同步加载即并发加载引入所需的资源文件，这在各个文件不互相依赖时使用可以提高加载速度。但如果各个文件之间存在依赖关系，比如以下栗子中，`jquery-ui` 与 `fullcalendar` 都依赖 `jquery`，而 `locale` 依赖 `fullcalendar`，这种情况下便不能同时加载所有文件，需要按照一定的依赖关系按次序加载资源。

```javascript
const assets = [
  'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/fullcalendar.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/locale/zh-cn.js'
]

// 同时加载 JS 文件
const loadAsyncAssets = async () => {
  const seq = assets.map(loadJS)
  Promise.all(seq)
    .then(() => {
      console.log('所有文件加载完成！')
    })
    .catch(console.error)
}

// 按次序加载 JS 文件
const loadAssets = async () => {
  for (const url of assets) {
    await loadJS(url)
  }
  console.log('所有文件加载完成！')
}
```

Just enjoy it ฅ●ω●ฅ
